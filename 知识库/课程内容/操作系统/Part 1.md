## 1.1 操作系统的目标和作用

### 1.1.1 操作系统的目标
在计算机上配置OS，主要目标是实现：方便性、有效性、可扩充性、开放性

**方便性**

未配置OS的计算机系统只能用机器语言编程，而配置了OS的计算机系统可以使用编译命令将高级语言编写的程序翻译成机器代码。

**有效性**

第一层含义是提高系统资源的利用率，第二层含义是提高系统的吞吐量。OS可以通过合理的组织计算机的工作流程，加速程序的运行，缩短程序的运行周期来提高系统的吞吐量。

**可扩充性**

OS从早期的无结构发展成模块化结构，进而发展成分层式结构，近年OS广泛采用微内核结构。该结构方便增添新的功能和模块，对原有功能和模块进行修改，具有良好的扩充性。

**开放性**

开放性是系统能遵守国际标准，特别是遵循开放系统互连（OSI）参考模型，凡遵守国际标准开发的硬件和软件都能彼此兼容。

### 1.1.2 操作系统的作用

1、OS 作为用户与计算机硬件系统之间的接口

 OS 作为用户与计算机硬件系统之间的接口，其含义是：OS 处于用户与计算机硬件系统之间，用户通过 OS 来使用计算机硬件系统，即用户在 OS 的帮助下能够方便、快捷、可靠地操纵计算机硬件来运行自己的程序。 用户使用计算机的主要方式有三种：**命令方式（命令接口）**、**系统调用方式（程序接口）**、**图形 / 窗口方式（图形接口，GUI）**。

 操作系统提供的接口主要分为两类：一类是命令接口，用户利用这些操作命令来组织和控制作业的执行；另一类是程序接口，编程人员可以使用它们来请求操作系统服务。

**（1）命令接口**

 使用命令接口进行作业控制的主要方式有两种，即联机控制方式和脱机控制方式。按作业控制方式的不同，可将命令接口分为联机命令接口和脱机命令接口。

 联机命令接口，又称交互式命令接口，适用于分时系统或实时系统的接口。它由一组键盘操作命令组成。用户通过控制台或终端输入操作命令，向系统提出各种服务要求。用户每输入一条命令，控制权就转给操作系统的命令解释程序，然后由命令解释程序解释并执行输入的命令，完成指定的功能。之后，将控制权转回控制台或终端，此时用户又可输入下一条命令。

 脱机命令接口，又称批处理命令接口，适用于批处理系统，它由一组作业控制命令组成。脱机用户不能直接干预作业的运行，而应事先用相应的作业控制命令写成一份作业操作说明书，连同作业一起提交给系统。系统调度到该作业时，由系统中的命令解释程序逐条解释执行作业说明书上的命令，从而间接地控制作业的运行。

**（2）程序接口**

 程序接口由一组 == 系统调用（也称广义指令）== 组成。用户通过在程序中使用这些系统调用来请求操作系统为其提供服务，如__使用各种外部设备__、__申请分配__和__回收内存__及其他各种要求。

 当前最为流行的是用户图形界面（GUI），即图形接口。GUI 最终是通过调用程序接口实现的，用户通过鼠标和键盘在图形界面上单击或使用快捷键，就能很方便地使用操作系统。

>   严格来说，图形接口不是操作系统的一部分，但图形接口所调用的__系统调用命令__是操作系统的一部分。

2、OS 作为计算机系统资源的管理者

 在一个计算机系统中，通常含有多种硬件和软件资源。归纳起来可以将这些资源分为 4 类：处理机、存储器、I/O 设备、信息（数据和程序）。OS 的主要功能是对这 4 类资源进行有效的管理。

处理机管理负责处理机的分配与控制；

存储器管理负责内存的分配与回收；

I/O 设备管理负责 I/O 设备的分配（回收）与操纵；

文件管理负责文件的存取、共享与保护等。

**（1）处理机管理**

  在多道程序下，处理记得分配和运行都以进程（或线程）为基本单位，因而对处理机管理可以归结为对进程的管理。并发是指计算机在同一时间段内同时运行多个进程，因此进程何时创建、何时撤销、如何管理、如何避免冲突、合理共享就是进程管理的最主要的任务。进程管理的主要功能包括__进程控制__、**进程同步**、**进程通信**、**死锁处理**、__处理机调度__等。

**（2）存储器管理**

 存储器管理是为了给多道程序的运行提供良好的环境，方便用户使用及提高内存的利用率，主要包括__内存分配与回收__、**地址映射**、__内存保护与共享__和__内存扩充__等功能。

**（3）文件管理**

 计算机中的信息都是以文件的形式存在的，操作系统中负责文件管理的部分称为文件系统。文件管理包括文件存储空间的管理、目录管理及文件读写管理保护等。

**（4）设备管理**

 设备管理的主要任务是完成用户的 I/O 请求，方便用户使用各种设备，并提高设备的利用率，主要包括__缓冲管理__、**设备分配**、__设备处理__和__虚拟设备__等功能。

3、OS 实现了对计算机资源的抽象

 没有任何软件支持的计算机称为裸机，它仅构成计算机系统的物质基础，向用户提供的仅是硬件接口（物理接口）。操作系统所提供的资源管理功能和方便用户的各种服务功能，将裸机改造成功能更强、使用更方便的机器；因此，通常把覆盖了软件的机器称为扩充机器或虚拟机。

### 1.1.3 推动操作系统发展的主要动力

**不断提高计算机系统资源的利用率**

20世纪50年代计算机系统特别昂贵，提高系统资源利用率成为最初的推动力，由此促成了单道批处理系统到多道批处理系统的演变，通过减少计算机的空闲时间提高了CPU和I/O的利用率。

20世纪60年代，又出现了可支持多个用户使用一台计算机的分时系统，使系统资源利用率提高，推动了计算机第一次大普及。与此同时，推出了能改善I/O设备和CPU利用率的假脱机系统。

20世纪70年代，提出了逻辑上扩大内存的虚拟存储器技术。之后网络环境下，在服务器上共享资源给全网用户，进一步提高了利用率。

**方便用户**

用户使用计算机和调试程序时不方便称为主要矛盾，称为推动OS发展的主要因素。20世纪60年代分时系统出现，不仅提高了资源利用率，还能实现人机交互。

20世纪90年代，图形用户界面的出现方便了用户对计算机的使用，推动了计算机的普及和广泛应用。

**器件不断更新换代**

随着信息技术的发展，尤其是微机芯片的不断更新换代，计算机性能提高，OS功能和性能也迅速提高。比如微机芯片从8位发展到16位、32位、64位，相应的OS出现了16位、32位、64位。

同时外部设备不断发展，OS支持的设备越来越多，比如光盘、移动硬盘、闪存、扫描仪、数码相机等。

**计算机体系结构不断发展**

计算机体系结构推动OS的发展，如计算机从单处理机系统发展成多处理机系统时，相应的OS从单处理机发展为多处理机OS；出现了计算机网络后，配置在计算机网络上的网络OS应运而生。

**不断提出新的应用需求**

例如，为了提高产品的质量和数量，需将计算机应用于工业控制中，此时在计算机上需要配置能进行实时控制的OS，由此产生了实时系统。

为了能满足用户在计算机播放视频，从网上下载视频等需求，在OS中添加了多媒体功能。

随着超大规模集成电路VLSI的发展，CPU体积越来越小，价格越来越便宜，大量智能设备（如智能手机）应运而生，嵌入式OS应运而生。


## 1.2 操作系统的发展过程

20世纪50年代中期，出现了第一个批处理系统；20世纪60年代中期，出现了多道批处理系统，不久又推出了分时系统，用于工业控制和武器控制的实时系统也问世。20世纪70-90年代，VLSI和计算机体系结构大发展的时代，微OS、多处理机OS、网络OS和分布式OS都得到了发展。

### 1.2.1 未配置操作系统

1、人工操作方式

 早期的操作方式是有用户将事先已经穿孔的纸带（或卡片），装入纸带输入机（或卡片输入机），再启动它们以将纸带（或卡片）上的程序和数据输入计算机，然后启动计算机运行。仅当程序运行完毕并取走计算结果后，才允许下一个用户上机。这种人工操作方式有以下两方面的缺点：

（1）**用户独占全机**，即一台计算机的全部资源由上级用户独占。

（2）**CPU 等待人工操作**。当用户进行装袋（卡）、卸带（卡）等人工操作时，CPU 及内存等资源是空闲的。

 可见人工操作方式严重降低了计算机资源的利用率，此即所谓的人机矛盾。

2、脱机 I/O 方式

 脱机 I/O 方式是事先将装有用户程序和数据的纸带装入纸带输入机，在一台外围机的控制下，把纸带上的程序和数据输入磁带。

 由于程序和数据的输入和输出都是在外围机的控制下完成的，即在脱离主机的情况下进行的

，故称其为脱机 I/O 方式。而把在主机的直接控制下进行的 I/O 的方式，称为联机 I/O 方式。脱机 I/O 方式的主要优点如下：

（1）**减少了 CPU 的空闲时间**。装带、卸带以及将数据从低速 I/O 设备送到高速磁带上（或反之）的操作，都是在脱机情况下由外围机完成的，并不占用主机时间，因此有效减少了 CPU 的空闲时间。

（2）**提高了 I/O 的速度**。当 CPU 在运行中需要输入数据时，系统是直接从高速磁带上将数据输入内存的，这极大地提高了 I/O 速度，进一步减少了 CPU 的空闲时间。

### 1.2.2 单道批处理系统

 为了能充分提高计算机的利用率，应尽量保持系统连续运行，即使在其处理完一个作业后，紧接着处理下一个作业，以减少系统的空闲时间。

1、单道批处理系统的处理过程

 为了实现对作业的连续处理，需要先把一批作业以脱机 I/O 的方式输入到磁带上，并在系统中配上监督程序，在其控制下，这批作业能一个接一个地被连续处理。虽然该系统对作业的处理是成批进行的，但在内存中始终只能保持一道作业，故称之为单道批处理系统。

 单道批处理系统是在解决人机矛盾和 CPU 与 I/O 设备速度不匹配矛盾的过程中形成的。单道批处理系统旨在提高系统资源的利用率和系统吞吐量。但这种单道批处理系统仍然不能充分利用系统资源，故现在已经很少使用。

2、单道批处理系统的缺点

 单道批处理系统最主要的缺点是，系统中的资源得不到充分利用，高速的 CPU 经常在等待低速的 I/O 完成状态。

3、单道批处理系统的主要特征：

（1）**自动性**。在顺利的情况下，磁带上的一批作业能自动地逐个运行，而无须人工干预。

（2）**顺序性**。磁带上的各道作业顺序地进入内存，各道作业的完成顺序与它们进入内存的顺序在正常情况下应完全相同，亦即先调入内存的作业先完成。

（3）**单道性**。内存中仅有一道程序运行，即监督程序每次从磁带上只调入一道程序进入内存运行，当该程序完成或发生异常状况时，才换入其后继程序进入内存运行。

### 1.2.3 多道批处理系统

1、多道程序设计的基本概念

 为了进一步提高资源的利用率和系统吞吐量，引入了多道程序设计技术，由此形成了多道批处理系统。

2、多道批处理系统的优缺点

（1）** 资源利用率高。** 引入多道程序机制使多道程序交替运行，以保证 CPU 一直处于忙碌状态；在内存中装入多道程序，不仅可以提高内存的利用率，还可以提高 I/O 设备的利用率。

（2）** 系统吞吐量大。**①CPU 和其他资源保持 “忙碌” 状态；②仅当作业完成时或运行不下去时才进行切换，系统开销小。

（3）** 平均周转时间长。** 由于作业要排队并依次进行处理，因而作业的周转时间较长，通常需要几个小时甚至几天。

（4）** 无交互能力。** 用户一旦把作业提交给系统，那么直至作业完成，用户都不能与自己的作业进行交互，这对用户修改和调试程序是极不方便的。

3、多道批处理系统需要解决的问题

（1）**争用处理机问题**：系统既要满足各道程序运行的需要，又要能提高处理机的利用率。

（2）**内存分配与保护问题**：系统应能为每道程序分配必要的内存空间，以使他们 “各得其所”，且不会因为某道程序出现异常情况而破坏其他程序。

（3）**I/O 设备分配问题**：系统应采取适当的策略来分配系统中的 I/O 设备，以达到既能方便用户对设备的使用，又能提高设备利用率的目的。

（4）**文件的组织与管理问题**：系统应能有效地组织存放在系统中大量的程序和数据，以使它们既便于用户使用，又能保证数据的安全性。

（5）**作业管理问题**：系统中存在着各种作业（应用程序），系统应能对系统中所有的作业进行合理的组织，以满足这些作业对应用户的不同要求。

（6）**用户与系统的接口问题**：为使用户能方便地使用 OS，OS 还应提供用户与 OS 之间的接口。

### 1.2.4 分时系统

1、分时系统的引入

 推动分时系统（time sharing system）形成和发展的主要动力，是为了满足用户对人机交互的需求用户的需求具体表现在以下两个方面：

（1）**人机交互**。用户希望能像早期使用计算机时一样，独占全机并对它进行直接控制，以便能方便地对程序中的错误进行修改。

（2）**共享主机**。用户们在共享一台计算机时，每个用户都希望能像独占全机一样，不仅可以随时与计算机进行交互，而且不会感觉到其他用户的存在。

 分时系统是指在一台主机上连接有多个配有显示器和键盘的终端所形成的系统，该系统允许多个用户同时通过自己的终端以交互方式使用计算机，并共享主机中的资源。

2、分时系统实现过程中的关键问题

 为了实现人机交互，必须解决的关键问题是：如何使用户能与自己的作业进行交互。为此，首先，系统必须能提供多个终端同时给多个用户使用；其次，当用户在自己的终端上键入命令时，系统应能及时接收并处理该命令，然后将处理结果返回给用户。此后，用户可根据系统的响应情况，再继续键入下一条命令，此即人机交互。亦即，允许有多个用户同时通过自己的键盘键入命令，系统也应能将全部命令及时接收并处理。

（1）**及时接收**。要做到及时接收多个用户键入的命令或数据，只须在系统中配置一个多路卡即可。多路卡的作用是实现时分多路复用（Time-Division Multiplexing，TDM），即主机能以很快的速度周期性地扫描各个终端，并在每个终端处停留一段很短的时间（如 30ms）以接收从终端发来的数据。此外，为了能使从终端上输入的数据被依次逐条地进行处理，还需要为每个终端配置一个命令缓冲区，用于暂存用户键入的命令或数据。

（2）**及时处理**。①采用作业直接进入内存的方式。因为作业在磁盘上是不能运行的，所以其应该直接进入内存。②采用轮转运行的方式。如果一个作业独占处理机而连续运行，那么其他作业就没有机会被调度运行。为了避免一个作业长期独占处理机，引入了时间片的概念。一个时间片就是一个很短的时间，如 30ms。系统规定每个作业每次只能运行一个时间片，然后就暂停该作业的运行，并立即调度下一个作业运行，不管它是否运行完毕。

3、分时系统的特征

（1）**多路性**，系统允许将多台终端同时连接到一台主机上，并按分时原则为每个用户服务。

（2）**独立性**，系统提供了一种每个用户在各自的终端上进行操作的用机环境，彼此之间互不干扰，给用户的感觉就像是他一人独占主机。

（3）**及时性**，用户的请求能在很短的时间内获得响应，通常仅为 1~3s。

（4）**交互性**，用户可以通过终端与系统进行广泛的人机对话。用户可以请求系统提供多方面的服务，如进行文件编辑和数据处理、访问系统中的文件系统和数据库系统、打印运行结果等。

### 1.2.5 实时系统

 “实时”具体指 “及时”；“实时计算” 的定义为：== 系统的正确性不仅由计算的逻辑结果来确定，而且还取决于产生结果的时间。== 实时系统（real time system）最主要的特征是将时间作为关键参数，必须对所接收的某些信号做出 “及时” 或“实时”的反应。

 实时系统是指系统能及时响应外部事件的请求，在规定的时间内完成对该事件的处理，并控制所有实时任务协调一致地运行。

1、实时系统的类型

（1）**工业控制系统**。

（2）**信息查询系统**。

（3）**多媒体系统**。

（4）**嵌入式系统**。

2、实时任务的类型

（1）**周期性实时任务**和**非周期性实时任务**。

 周期性实时任务：外部设备周期性地发出激励信号给计算机，要求它按指定周期循环执行，以便周期性地控制某外部设备。

 非周期性实时任务：无明显的周期性但必须联系一个截止时间（deadline），或称最后期限，可分为两种：①开始截止时间：某任务在某时刻以前必须开始执行；②完成截止时间：某任务在某时刻以前必须完成执行。

（2）**硬实时任务**和**软实时任务**

 硬实时（hard real time，HRT）任务是指系统必须满足任务对截止时间的要求，否则可能出现难以预测的后果。

 软实时（soft real time，SRT）任务联系着一个截止时间，但并不严格，若偶尔错过了任务的截止时间，其对系统产生的影响也不会太大。

3、实时系统的特征

（1）**多路性**。系统周期性地对多路现场信息进行采集，并对多个对象或多个执行机构进行控制。

（2）**独立性**。信息查询系统中的每个终端用户在与系统进行交互时，彼此相互独立、互不干扰；在实时控制系统中，对信息的采集和对对象的控制，也是彼此互不干扰的。

（3）**及时性**。实时控制系统的实时性是以控制对象所要求的截止时间来确定的，一般为秒到毫秒级。

（4）**交互性**。实时操作系统的交互性有一定的限制，它并不能像分时系统那样向终端用户提供数据处理、资源共享等服务。

（5）**可靠性**。实时系统要求系统高度可靠，往往采取了多种容错措施，以保障系统及数据的安全性。

### 1.2.6 微机操作系统

 配置在微机上的 OS 称为微机 OS，由于使用者通常为个人，因此其也被称为个人计算机（personal computer）。

> 最早诞生的微机 OS 是配置在 8 位微机上的 CP/M

现在流行的微机 OS 按运行方式可以分为以下几类：

1、单用户单任务 OS

 单用户单任务 OS 只允许一个用户上机，且只允许用户程序作为一个任务运行。

 最有代表性的单用户单任务 OS 是 CP/M（8 位）和 MS-DOS（16 位）

2、单用户多任务 OS

 单用户多任务 OS 只允许一个用户上机，但允许用户把程序分为若干个任务并发执行，从而有效地改善了系统性能。

 最有代表性的单用户多任务 OS 是由微软公司退出的 Windows 系列，如 Windows3.1、Windows95/98 等。

3、多用户多任务 OS

 多用户多任务 OS 允许多个用户通过各自的终端使用同一台机器，共享主机系统中的各种资源，而每个用户程序又可进一步分为几个任务，使它们能并发执行，从而进一步提高系统资源的利用率和系统吞吐量。

 最有代表性的多用户多任务 OS 是 UNIX 系统、各种类 UNIX 系统（如 Solaris、Linux 等）以及 Windows NT/Server 系列的系统。

 多用户多任务 OS 除了具有界面良好、管理方便和适于普及等优点外，还具有支持多用户使用、可移植性良好、功能强大、通信能力强等优点。

### 1.2.7 嵌入式操作系统

1、嵌入式系统

 == 嵌入式系统（embedded system）== 是为了完成某个特定功能而设计的系统，或是具有附加机制的系统，或是其他部分的计算机硬件与软件的结合体。

2、嵌入式 OS

 嵌入式 OS 是指应用于嵌入式系统的 OS。目前在嵌入式领域广泛应用的 OS 有嵌入式（实时）μC/OS-Ⅱ、嵌入式 Linux、Windows Embedded、VxWorks，以及应用在智能手机和平板电脑上的 Android、iOS 等。

3、嵌入式 OS 的特点

（1）**系统内核小**

（2）**系统精简**

（3）**实时性高**

（4）**具有可配置性**

### 1.2.8 网络操作系统

1、网络 OS 的特征

（1）**硬件独立性**：系统可以运行在各种硬件平台上。

（2）**接口一致性**：系统为网络中的共享资源提供一致性的接口，针对同一性质的资源，采用统一的访问方式和接口。

（3）**资源透明性**：系统能对网络中的资源进行统一管理，能够根据用户的要求对资源进行自动选择和分配。

（4）**系统可靠性**：系统利用资源在地理上分散的优点，通过统一管理、分配和调度手段，确保了整个网络的安全可靠。如果一个节点和通信链路出现故障，则可屏蔽该节点或重新定义新的通信链路，以保证网络的正常运行。

（5）**执行并行性**：系统不仅实现了在每个节点计算机中各道进程的并发执行，而且实现了网络中多个节点计算机上的并行执行。

2、网络 OS 的功能：

（1）**连接的建立与拆除**；

（2）**报文的分解与组装**；

（3）**传输控制**；

（4）**流量控制**；

（5）**差错的检测与纠正**。

### 1.2.9 分布式操作系统

1、分布式系统

 分布式系统（distributed system），是基于软件实现的一种多处理机系统，是多个处理机通过通信线路互联而构成的松散耦合系统，系统的处理和控制功能分布在各个处理机上。换言之，分布式系统是利用软件系统的方式构建在计算机网络上的一种多处理机系统。

 分布式系统应具有以下几个主要特征：

（1）**分布性**：分布式系统有多台计算机组成，从位置和地域范围来看，它们是分散的和广阔的，此即地理位置的分布性。从系统的功能来看，功能分散在系统的各节点计算机上，此即资源的分布性。从系统的控制来看，在一般的分布式系统中，计算机没有主从之分，此即控制的分布性。其中资源和控制的分布性也称为自治性。

（2）**透明性**：分布式系统的系统资源被所有计算机共享。

（3）**同一性**：分布式系统中的若干台计算机可以通过互相协作来完成同一任务，或者说一个程序可以分布在几台计算机上并行地运行。

（4）**全局性**：系统具备一个全局性的进程通信机制，系统中的任意两台计算机都可以通过该机制实现信息交换。

2、分布式 OS

 分布式 OS 是配置在分布式系统上的公用 OS，其以全局方式对分布式系统中的所有资源进行统一管理，可以直接对系统中地理位置分散的各种物理和逻辑资源进行动态分配和调度，有效地协调和控制各个任务的并行执行，协调和保持系统内的各个计算机间的信息传输与协作运行，并向用户提供一个统一的、方便的、透明的使用系统界面和标准接口。分布式 OS 保持了网络 OS 所拥有的全部功能，同时还具有透明性、内聚性、可靠性、高性能等特点。

 分布式 OS 还包括以下功能：

（1）**通信管理功能**。

（2）**资源管理功能**。

（3）**进程管理功能**。

## 1.3 操作系统的基本特征

### 1.3.1 并发

系统中的程序能并发执行，才能有效地提高系统中资源的利用率。

> 并行与并发：
>
> 并行指两个或多个事件在同一时刻发生，并发是两个或多个事件在同一时间间隔内发生。
>
> 在多道程序环境下，并发是指在一段时间内宏观上多个程序在同时运行；在单处理机系统中，每一时刻仅能有一道程序执行，在微观上这些程序只能分时交替运行。也就是说宏观上4道程序同时运行，但微观上4个程序分时交替执行。
>
> 如果计算机系统有多个处理机，多个任务可分到多个处理机并发执行。

进程：

进程是指在系统中能独立运行并作为资源分配对象的基本单位，由一组指令、数据、堆栈构成，是一个能独立运行的活动实体。

未引入进程的系统中，同属于一个应用程序的计算程序和I/O程序只能顺序执行，但分别为他们建立一个进程后，两个进程便可并发执行。

### 1.3.2 共享

 在 OS 环境下的资源共享（sharing），或称为资源复用，是指系统中的资源可供内存中多个并发执行的进程共同使用。目前实现资源共享的主要方式有如下两种：

1、**互斥共享方式**

2、**同时共享方式**

### 1.3.3 虚拟

 在 OS 中，把通过某种技术将一个物理实体变为若干个逻辑上对应的物的功能，称为 “虚拟”。前者是实的，即实际存在的；后者是虚的，是用户感觉存在的东西。用于实现虚拟的技术称为虚拟技术。在 OS 中是利用时分复用和空分复用技术来实现 “虚拟” 的。

1、**时分复用技术（Time Division Multiplexing，TDM）**

（1）**虚拟处理机技术**。利用多道程序设计技术，为每道程序建立至少一个进程，使多道程序并发执行。用户感觉到的处理机称为虚拟处理机。

（2）**虚拟设备技术**。利用时分复用技术，将一台物理上的 I/O 设备虚拟为多台逻辑上的 I/O 设备，并允许每个用户占用一台逻辑上的 I/O 设备。

2、**空分复用技术（Space Division Multiplexing，SDM）**

 空分复用技术是利用存储器的空闲空间（如某道程序阻塞时被换出到外存而空出来的内存空间）来存放其他程序以提高内存利用率的。

### 1.3.4 异步（Asynchronism）

 由于资源等因素的限制，进程的执行通常不可能 “一气呵成”，而是会以“停停走走” 的方式运行。换言之，进程以人们不可预知的速度向前推进，此即进程的异步性（asynchronism）。

1.4 操作系统的运行环境
-------------

### 1.4.1 硬件支持

 现代通用计算机系统包括一个或多个 CPU 和若干个设备控制器，通过公用总线相连而成，该总线提供了共享内存的访问功能。每个设备控制器负责一类特定的设备。CPU 和设备控制器可以并发执行，但会竞争访问共享内存。为了确保访问共享内存的有序性，需要内存控制器来协调它们对内存的访问

### 1.4.2 操作系统内核（OS Kernel）

 现代 OS 一般会划分若干层次，再将不同功能分别设置在不同层次中。  
 通常将一些与**硬件紧密相关的模块（如中断处理程序等）**、**各种设备常用的驱动程序**、 **运行频率较高的模块（如时钟管理模块、进程调度模块等）** 以及**许多模块所公用的一些基本操作**，都安排在紧靠硬件的软件层次中，并将它们常驻内存，称为操作系统内核（OS Kernel）。  
 这种安排方式的目的在于：  
1、便于对这些软件进行保护，防止它们遭受其他应用程序的破坏；  
2、提高操作系统的运行效率。

## 1.5 操作系统的主要功能

引入OS的主要目的是，为多道程序的运行提供良好的运行环境，以保证多道程序能有条不素地、高效地运行，并能最大限度地提高系统中各种资源的利用率和方便用户的使用。为此，传统OS中应具有处理机管理、存储器管理，设备管理和文件管理等基本功能。此外，为了加用户使用OS,还须向用户提供方便的用户接口。

### 1.5.1 处理机管理功能

在传统的多道程序系统中。处理机的分配和运行都以进程为基本单位，因而对处理机的理可归结为对进程的管理。处理机管理的主要功能有：创建和撒销进程。对各进程的运行进协调，实现进程之间的信息交换，以及按照一定的算法把处理机分配给进程。

**1、进程控制**

在多道程序环境下。为使作业能并发执行。必须为每道作业创建一个或几个进程，并为毅分配必要的资源。当进程运行结束时，应立即撒销该进程。以便能及时回收该进程所占用的名类资源，供其他进程使用。在设置有线程的0S中，进程控制还应包括为一个进程创建若干个线程.以提高系统的并发性。因此，进程控制的主要功能是：为作业创建进程，撤镇（终止结束的进程。以及控制进程在运行过程中的状态转换

**2、进程同步**

为使多个进程能有条不素地运行，系统中必须设置相应的进程同步机制。该机制的主要：务是对多个进程（含线程）的运行进行协调。有两种协调方式：①进程互斥方式，这是指各剂程在对临界资源进行访问时，应采用互下万式：②进程同步方式，这是指在相互合作以完成共同任务的各进程间，由同步机构对它们的执行次序加以协调。最简单的用于实现进程互斥的制是，为每个临界资源配置一把镇。当锁打开时，进程可以对该临界资源进行访问：而当镜：上时，禁止进程访问该临界资源。在实现进程同步时，最常用的机制是信号量机制。

**3、进程通信**

当有一组相互合作的进程在完成一个共同的任务时，在它们之间往往需要交换信息。朗如，有3个相互合作的进程，即输人进程，计算进程和打印进程：其中，输人进程负责将所输的数据传送给计算进程：计算进程利用输入的数据进行计算，并把计算结果传送给打印进园最后由打印进程把计算结果打印出来。进程通信的任务是实现相互合作进程之间的信息交换当相互合作的进程处于同一计算机系统时，在它们之间通常会采用直接通信方式，即进程利用发送命令.直接将消息(m©ssage)挂到目标进程的消息队列上，以后由目标进程利铜接收命令从其消息队列中取出消息。

**4、调度**

在传统0S中，调度包括作业调度和进程调度两步。①作业调度：作业测度的基本任务照一定的算法，从后备队列中选出若干个作业，并为它们分配运行所需的资源：在将这些作调人内存后，分别为它们建立进程，以使它们都成为可能会获得处理机的就绪进程，并将这进程插人就绪队列。2进程测度：进程网度的任务是按照一定的算法，从进程的就绪队列中出一个进程。将处理机分配给它，并为它设置运行现场，使其投人执行

### 1.5.3 存储器管理功能

存储器管理的主要任务是，为多道程序的运行提供良好的环境、提高存储器的利用率便用户使用，并能从逻辑上扩大内存。为此，存储器管理应实现内存分配和回收、内存保护地址映射和内存扩充等功能。

1.内存分配和回收

内存分配的主要任务是：①为每道程序分配内存空间，使它们“各得其所”：②提高存储器的利用率，尽量减少不可用的内存空间（内部碎片）；③允许正在运行的程序申请附加的内存空间，以适应程序和数据动态增长的需要。OS在实现内存分配时，可采取静态和动态两种分配方式。①静态分配方式：每个作业的内存空间是在作业装入时确定的，在作业装入后的整个运行期间，不允许该作业再申请新的内存空间，也不允许该作业在内存中“移动”。2动态分配方式：每个作业所要求的基本内存空间虽然也是在装入时确定的，但允许作业在运行过程中继续申请新的附加内存空间，以适应程序和数据的动态增长，也允许作业在内存中“移动”。内存属于有限资源。随着系统的运行，内存会被逐渐消耗。因此，当程序执行完毕后，需要将其所占用的内存及时回收再分配，以提高系统内存资源的利用率。内存回收的任务就是回收程序所占用的内存，并根据当前的内存管理算法将回收的内存经过处理放入对应的管理数据结构中，供下次分配时使用。

2.内存保护

内存保护的主要任务是：①确保每道用户程序都仅在自己的内存空间中运行，彼此互不干扰：②绝不允许用户程序访问OS的程序和数据，也不允许其转移到非共享的其他用户程序中去执行。为了确保每道程序都只在自己的内存空间中运行，必须设置内存保护机制。一种比较简单的内存保护机制是：设置两个界限寄存器，分别用于存放正在执行程序的上界和下界。在程序运行时，系统须对每条指令所要访问的地址进行检查，如果发生越界，则发出越界中断请求，以停止该程序的执行。

3.地址映射

在多道程序环境下，由于每道程序经编译和链接后所形成的可装入程序，其地址都是从0开始的，而又不可能将它们从内存的“0”地址（物理）开始装人，因此（各程序段的）地址空间内的逻辑地址与其在内存空间中的物理地址并不一致。为保证程序能正确运行，存储器管理必须提供地址映射功能，即能够将地址空间中的逻辑地址变换为内存空间中与之对应的物理地址。该功能应在硬件的支持下实现。

4.内扩充

内存扩充并非是指从物理上去扩大内存容量，而是借助虚拟存储技术，从逻辑上去扩大内存容量，使用户感觉到的内存容量比实际内存容量大得多，以便让更多的用户程序能并发运行。这样既满足了用户的需要，又改善了系统的性能。为了能在逻辑上扩大内存，系统必须设置内存扩充机制（包含少量的硬件），用于实现下述功能。①请求调入功能：系统允许在仅装入部分用户程序和数据的情况下，便能启动该程序运行：在程序运行过程中，若发现继续运行所需的程序和数据尚未装入内存，则可向O$发出请求，由OS从磁盘中将所需部分调入内存，以使程序能够继续运行。2置换功能：若发现在内存中已无足够的空间来装人需要调入的程序和数据时，则系统应能将内存中的一部分暂时不用的



### 1.5.6 现代操作系统的新功能

现代OS是在传统OS的基础上发展起来的，它除了具有传统OS的功能外，还增加了保障系统安全、支持用户通过联网获取服务和可处理多媒体信息等功能。

**1、保障系统安全**

通常，政府机关和企事业单位有大量重要的信息，它们必须被高度集中地存储在计算机系统中。因此，如何确保在计算机系统中存储和传输数据的保密性、完整性和系统安全性，便咸了计算机系统亟待解决的重要问题；而保障系统安全的任务，也责无旁贷地落到了现代OS的身上。

虽然在传统OS中也采取了一些保障系统安全的措施，但随着计算机技术的进步和网络的普及，传统的安全措施已远不能满足要求。为此，在现代0S中采取了多种有效措施来确保系统的安全。这里仅介绍保障系统安全的几个技术问题。

- 认证技术，是一个用来确认被认证的对象是否名副其实的过程，即用来确定对象的真实性，以防止入侵者进行假冒与篡改等。例如，身份认证，即通过验证被认证对象的一个或多个参数的真实性和有效性来确定被认证对象是否名副其实的。因此，在被认证对象与要验证的那些参数之间，应存在严格的对应关系

- 密码技术，对系统中所须存储和传输的数据进行加密，使之成为密文：这样，攻击者即使截获了数据，也无法了解数据的内容。只有指定的用户才能对该数据加以解密，透而了解其内容。因此，该技术有效地保护了系统中信息资源的安全性。近年来。国内外爸应用数据加密技术，以保障计算机系统的安全性。
- 访向控制技术。可通过两种途径来保画系统中资源的安全：一是通过对用户存取权限的设置，可以限定用户只能访问被允许访同的资源。这样也就限定了用户对系统资源的访问范围：二是通过对文件属性的设置，可以保南指定文件的安全性，例如，设置文件属性为“只读”后，该文件就只能被读而不能被修改。

- 反病毒技术，对于病毒（特指计算机病毒）的威胁，最好的解决方法是预防，即不让病毒侵入系统，但要完全做到这一点是十分困难的，因此还需要非常有效的反病毒软件来检测病毒。在反病毒软件被安装到计算机上后，其便可对硬盘上所有的可执行文件进行扫描，以检查硬盘上的所有可执行文件，若发现有病毒，则立即将其清除。

**2、支持用户通过联网获取服务**

在现代OS中，为支持用户联网以取得网络所提供的各类服务，如电子邮件服务、Vb服务等，应在OS中增加面向网络的功能，用于实现网络通信和资源管理，以及提供用户取得网络服务的手段。作为一个网络OS,其应当具备多方面的功能，包括：

- 网络通信，用于在源主机和目标主机之间实现无差错的数据传输，如通信链路建立与拆除、传输控制、差错控制和流量控制等
- 资源管理，对网络中的共享资源（硬件和软件）实施有效的管理，以协调各用户对共享资源的使用，保证数据的安全性和一致性，典型的共享硬件资源有硬盘、打印机等，共享软件资源有文件、数据等；
- 应用互操作，在一个由若干个不同网路互联所构成的互联网络中，必须提供应用互操作功能，以实现信息的互通性和信息的互用性。信息的互通性，是指在处于不同网铬中的用户之间能实现信息的互通。信息的互用性，是指用户可以访问不同网络中的文件系统和数据库系统中的信息。

**3、可处理多媒体信息**

一个支持多媒体的OS，必须能处理音频和视频等多媒体信息。为此，OS还增加了处理多媒体信息的功能：

- 接纳控制功能，在多媒体系统中，为了保证同时运行多个实时进程的截止时间，需要对系统中运行的SRT任务数目、驻留在内存中的ST任务数目加以限制，为此设置了相应的接纳控制功能，如媒体服务器的接纳控制、存储器接纳控制和进程接纳控制等
- 实时调度，多媒体系统中的SRT任务往往都是一些要求较严格的、周期性的SRT任务，例如为了保证动态图像的连续性，图像的更新周期必须在40ms之内，因此在进行ST任务调度时，不仅需要考虑进程调度的策略，还需要考虑进程调度的接纳度等，相比传统OS要复杂得多
- 存储多媒体文件，为了实现该功能，对OS所提出的最重要的要求是，能把硬盘上的数据快速地传送到输出设备上，因此，对传统文件系统中数据的离散存放方式和磁盘寻道方式都要加以改进。

## 1.6 操作系统的结构

早期OS的规模很小，如只有几十KB，完全可以由一个人用几个月的时间编制出来。此时，编制程序基本上是一种技巧，OS是否有结构并不那么重要。但随着OS规模的愈来愈大，其所具有的代码也愈来愈多，往往需要由数十人、数百人甚至更多的人参与，通过分工合作来共同完成其设计。这意味着，应采用工程化的开发方法来对大型软件进行开发，由此产生了“软件工程学”。

软件质量可用这样几个指标来评价：功能性、有效性、可靠性、易用性、易维护性和易移植性。为此，先后产生了多种OS开发方法，如模块化方法、结构化方法和面向对象的方法等。利用不同的开发方法，所开发出的OS将具有不同的结构。

### 1.6.1 简单结构

在早期开发OS时，设计者只把他的注意力放在了功能的实现和获得更高的效率上，而缺乏首尾一致的设计思想。此时的OS是为数众多的一组过程的集合，每个过程均可任意地调用其他过程，这致使OS内部既复杂、又混乱。因此，这种OS是无结构的，也有人把它称为整体系统结构或简单结构。

此时，程序设计的技巧仅在于如何编写紧凑的程序，以便于有效地利用内存。当系统不太大时，在一个人能够完全理解和掌握的情况下，设计出的OS所存在的问题还不是太大：但随着系统的不断扩大，所设计出的OS就会变得既庞大、又杂乱。这一方面会使所综写的程序错误很多，给调试工作带来很多困难；另一方面会使程序难以阅读和理解，增加了维护人员的负担。

简单结构OS的一个典型例子是MS-DOS系统。该系统并没有很好地区分功能的接口和层次。例如，应用程序能访问基本的I/O程序，并能将数据直接写到显示器和磁盘。这种自由度使MS-DOS系统易受错误（或恶意）程序的伤害，进而可能会导致整个系统崩溃。当然，MS-DOS系统还受限于当时的硬件，其所用的intel 8088微处理机未能提供双模式和硬件保护功能，因此，设计人员除了允许应用程序访问基础硬件外，没有其他选择。

### 1.6.2 模块化结构

**1、模块化程序设计技术的基本概念**

模块化程序设计技术，是20世纪60年代出现的一种结构化程序设计技术。该技术基于“分解”和“模块化”原则来控制大型软件的复杂度。为使OS具有较清晰的结构，不再将众多的过程直接构成OS，而是将OS按其功能精细地划分为若干个具有一定独立性和大小的模块。每个模块具有某方而的管理功能，如进程管理、存储器管理、文件管理等，并仔细地规定好各模块间的接口，使各模块之间能通过该接口实现交互。然后进一步将各模块细分为若干个具有一定功能的子模块，如把进程管理模块分为进程控制、进程调度等子模块，各子模块之间的接口同样也要规定好。若子模块较大，则可将其再进一步细分。我们把这种设计方法称为模块接口法，由此构成的的OS就是具有模块化。图1.9所示为由模块、子模块等构成的具有模块化结构的OS。

![image-20220924091334037](https://pic.imgdb.cn/item/632e5a1616f2c2beb1703b6b.png)

**2、模块独立性**

在采用模块一接口法设计OS结构时，关键问题是模块的划分和规定好模块之间的接口。如果在划分模块时将模块划分得太小，则虽然可以降低模块本身的复杂性，但也会导致模块之间的联系过多，进而导致系统比较混乱；如果将模块划分得过大，则又会增加模块内部的复杂性。因此在划分模块时，应在“两者”之间进行权衡。

另外，在划分模块时，必须充分注意模块的独立性问题，因为模块独立性越高，各模块间的交互就越少，系统的结构也就越清晰。衡量模块的独立性有以下两个标准：①内聚性，指模块内部各部分间联系的紧密程度，内聚性越高，模块独立性越强：②耦合度，指模块间相互联系和相互影响的程度，显然，桐合度越低，模块独立性越强。

**3、模块一接口法的优缺点**

利用模块-接口法开发的OS,较无结构0S具有以下显著优点：①提高了OS设计的正确性、可理解性和易维护性；②增强了OS的可适应性：③加速了OS的开发过程

模块化结构设计仍存在下述问题：①在设计OS时，对各模块间接口的规定，很难满足划分完成后模块对接口的实际需求；②在OS设计阶段，设计者必须做出一系列的决定（决策)，每个决定必须建立在上一个决定的基础上，但在模块化结构设计中，各模块的设计齐头并进，无法寻找一个可靠的决定顺序，进而造成了各种决定的“无序性”，这将使程序员很难做到“设计中的每一步决定”都是建立在可靠的基础上的，因此模块-接口法又被称为“无序模块法”。

目前，设计OS的常用方法是采用可加载的内核模块(loadable kernel module)。这里，内核有一组核心组件，无论在启动时还是在运行时，内核都可以通过模块链入额外服务。这种类型的设计常见于现代UNIX系统（如Solaris、Linux:或Mac OS X等）以及Windows系统的实现过程中。这种设计的思想是：内核提供核心服务，而其他服务可在内核运行时动态实现。动态链接服务优于直接添加新功能到内核，这是因为对于每次更改，后者都需要重新编译内核。

### 1.6.3 分层式结构

**1、分层式结构的基本概念**

为了将模块-接口法中“决定顺序”的无序性变为有序性，引入了有序分层法。有序分层法的设计任务是，在目标系统A和裸机系统（又称宿主系统）A之间，铺设若干个层次的软件A,A2,,A1,使A通过A,Ar,A2,A,层软件，最终能在A上运行。在OS中，常采用自底向上分层设计法来铺设这些中间层软件。

自底向上分层设计法的基本原则是：每一步设计都是建立在可靠的基础上的。为此规定，每一层仅能使用其低层所提供的功能和服务，这样可使系统的调试和验证都变得更容易。例如，在调试第一层软件A,时，由于它使用的是一个完全确定的物理机器（宿主系统）所提供的功能，在对A,层软件经过精心设计和几乎是穷尽无遗的测试后，可以认为A,是正确的，而且它与其所有的高层软件A,A,,A,无关；同样在调试第二层软件A,时，它也只使用了A,层软件和物理机器所提供的功能，而与其高层软件A,A,…,A,无关，如此一层一层地自底向上增添软件层，每层都实现若干功能，最后总能构成一个可以满足用户需婴的OS。在用这种方法构成OS时，已将一个OS分为若干个层次，每层又由若干个模块组成，各层之间只存在单向的依赖关系，即高层仅依赖于紧邻它的低层。

**2、分层式结构的优缺点**

分层式结构的主要优点有：①易保证系统的正确性，自下而上的设计方式，使所有设计中的决定都是有序的，或者说是建立在较为可靠基础上的，这样比较容易保证整个系统的正确性；②可保证系统的易维护性和可扩充性，若想在系统中增加、修改或替换一个层次中的模块或整个层次，则只要不改变相应层次间的接口，就不会影响其他层次，这必将使系统维护和打充变得更加容易。

分层式结构的主要缺点是系统效率较低。由于分层式结构是分层单向依赖的，必须在各层之间都建立层问的通信机制，OS每执行一个功能，通常要自上而下地穿越多个层次，这无疑会增加系统的通信开销，从而导致系统效率降低。

### 1.6.4 微内核结构

OS的微内核(microkernel)结构，80年代后发展起来。支持处理机运行，适用于分布式系统环境。当前比较流行的、能支持多处理机运行的OS，几乎全部都采用了微内核结构，例如卡内基梅隆大学研制的Mach OS和Windows2000/XP系统

**1、微内核OS的基本概念**

为了提高OS的“正确性”“灵活性”“易维护性”和”可扩充性”，在进行现代OS结构设计时，即使在单处理机环境下，也大都会采用基于客户/服务器模式的微内核结构，将OS划分为两大部分：微内核和多个服务器。至于什么是微内核结构，现在尚无公认的定义，但可以从以下4个方面对微内核结构的OS进行描述。

- 足够小的内核。

在微内核结构的OS中，内核是指精心设计的、能实现现代OS最基本核心功能的小型内核，微内核并不是一个完整的OS,而只是OS中最基本的部分，它通常包含：①用于处理与硬件紧密相关的部分；②一些最基本的功能；③客户和服务器之间的通信。它们只是为构建通用0S提供了一个重要基础。这样就可以确保把OS内核做得很小。

- 基于客户/服务器模式。

由于客户/服务器模式具有非常多的优点，故在单处理机微内核结构的OS中几乎无一例外地都采用了客户/服务器模式，将OS中最基本的部分放入内核中，而把OS的绝大部分功能都放在微内核外面的一组服务器（进程）中实现，例如，用于提供进程（线程）管理功能的进程（线程)服务器、提供虚拟存储器管理功能的虚拟存储器服务器、提供I/O设备管理功能的I/O设备服务器等，都是被作为进程来实现的，它们运行在用户态。客户与服务器之间是借助微内核提供的消息传递机制来实现信息交互的。图1-10所示为单处理机环境下的客户服务器模式。

![image-20220924092955509](https://pic.imgdb.cn/item/632e5dec16f2c2beb1745011.png)

- 采用策略与机制分离原则

在现代OS的结构设计中，经常会采用策略与机制分离原则来构造OS结构。所谓机制，是指实现某一功能的具体执行机构：而策略，则是指在机制的基础上，借助于某些参数和算法来实现该功能的优化或达到不同的功能目标。通常，机制处于系统的基层，而策略则处于系统的高层。在传统OS中，将机制放在OS内核的较低层，将策略放在OS内核的较高层。而在微内核OS中，通常将机制放在OS的微内核中。正因为如此.才有可能将内核做得很小。

- 采用面向对象技术

OS是一个极其复杂的大型软件系统，我们不仅可以通过结构设计来降低OS的复杂度，还可以基于面向对象技术中的“抽象”和“隐蔽”原则控制系统的复杂性，再进一步利用“对象”“封装”“继承”等概念来确保0S的“正确性”“可靠性”“易修改性”“易扩展性”等，并提高OS的设计速度。正因面向对象技术能带来如此多的好处，所以面向对象技术被广泛应用于现代OS的设计中。



**2、微内核的基本功能**

微内核应具有哪些功能，或者说哪些功能应放在微内核中，哪些功能应放在微内核外，目前尚无明确的规定。现在通常采用策略与机制分离原则，将机制部分以及与硬件紧密相关的部分放人微内核中。由此可知，微内核通常具有以下几个方面的功能。

- 进程（线程）管理

大多数的微内核OS,对于进程管理功能的实现，都采用策略与机制分离原则。例如，为实现进程（线程）调度功能，须在进程管理中设置一个或多个进程（线程）优先级队列，以将指定优先级进程（线程）从所在队列中取出，并将其投入执行。由于这一部分属于调度功能的机制部分，故应将它放入微内核中。如何确定各类用户（进程）的优先级，又应如何确定每类用户中各用户的优先级等问题，都属于策略问题，可将它们放入微内核外的进程（线程）管理服务器中，以完成上述“确定”任务。由于进程（线程）之间的通信功能是微内核OS最基本的功能，会被频繁使用，因此几乎所有的微内核0S都将进程（线程）之间的通信功能放人微内核中。此外，还将进程的切换、线程的调度以及多处理机之间的同步等功能也放人微内核中。

- 低级存储器管理

通常在微内核中，只配置最基本的低级存储器管理机制，例如，用于实现将用户空间的逻辑地址变换为内存空间的物理地址的页表机制和地址变换机制，这一部分是依赖于机器的，因此放入微内核中。而实现虚拟存储器管理的策略，包含应采用何种页面置换算法、采用何种内存分配与回收策略等，则应放在微内核外的存储器管理服务器中。

- 中断和陷入处理

大多数微内核OS都将与硬件紧密相关的一小部分放入微内核中进行处理，此时微内核的主要功能是捕获所发生的中断和陷人事件，并进行相应的前期处理，如进行中断现场保护、识别中断或陷入事件的类型等，然后将有关事件的信息转换成消息，并把它发送给相关的服务器：由服务器根据中断或陷入事件的类型，调用相应的处理程序来进行后期处理。在微内核0S中，将进程管理、存储器管理、0管理等功能一分为二，并将其中属于机制的、很小的一部分放入微内核中，另外的绝大部分放在微内核外的各种服务器中。事实上，微内核外的大多数服务器都要比微内核大。这进一步说明了为什么能在采用客户/服务器模式后，还能把微内核做得很小的原因。



**3、微内核OS的优点**

由于微内核结构是建立在模块化、层次化结构的基础上的，并采用了客户/服务器模式和面向对象的程序设计技术，因此，微内核结构的OS是集各种技术优点之大成。现将其优点细述如下。

- 提高了系统可扩展性

由于微内核OS的许多功能是由相对独立的服务器软件来实现的，当开发了新的硬件和软件时，微内核OS只须在相应的服务器中增加新的功能，或再增加一个专门的服务器即可。与此同时，微内核结构也必然会改善系统的灵活性，因为不仅可在0S中增加新的功能，还可修改原有功能，以及删除已过时的老功能，进而形成一个更为精干的、有效的OS。

- 增强了系统的可常性。

一方面，微内核是经过精心设计和严格测试的，这容易保证其正确性；另一方面，微内核提供了规范而精简的应用程序接口(application programming interface,API),这为在微内核外部编写高质量的程序创造了条件。此外，由于所有服务器都运行在用户态，服务器与服务器之间采用的是消息传递通信机制，因此，某个服务器出现错误不会影响微内核，也不会影响其他服务器。

- 增强了系统的可移植性

随着硬件的快速发展，出现了各种各样的硬件平台，作为一个好的OS,必须具备可移植性，以使自身能够较容易地运行在不同的计算机硬件平台上。在微内核结构的OS中，所有与特定CPU和/O设备有关的代码，均放在微内核和微内核下面的硬件隐藏层中，而OS的其他绝大部分组件（各种服务器）均与硬件平台无关，因而，把0S从一个计算机硬件平台移植到另一个计算机硬件平台上所须做的修改是比较小的。

- 提供了对分布式系统的支持

在微内核OS中，由于客户和服务器之间、服务器和服务器之间的通信，均采用消息传递通信机制实现，微内核OS能很好地支持分布式系统和网络系统。事实上，只要在分布式系统中赋予所有进程和服务器唯一的标识符，在微内核中再配置一张系统映射表（即进程和服务器的标识符与它们所驻留的机器之间的对应表)，在进行客户与服务器通信时，只须在所发送的消息中标上发送进程和接收进程的标识符，微内核便可利用系统映射表将消息发往“目标”，而无论“目标”驻留在哪台机器上。

- 融入了而向对象技术

在设计微内核OS时，采用了面向对象技术，其中的“封装”“继承”“对象类”和“多态性”，以及在对象之间采用消息传递机制等，都十分有利于提高系统的“正确性”“可靠性”“易修改性”“易扩展性”等，而且还能显著减少开发系统的开销。



**4、微内核OS存在的问题**

应当指出，在微内核OS中，由于采用了非常小的内核，客户服务器模式和消息传递机制，虽给微内核OS带来了许多优点，但也使微内核OS存在着缺点，其中最主要的缺点是相比于早期的OS,微内核OS的运行效率有所降低。效率降低最主要的原因是，在完成一次客户对OS提出的服务请求时，需要利用消息实现多次交互，以及进行用户内核模式和上下文的多次切换。然而，在早期的OS中，用户进程在请求取得OS服务时，一般只须进行两次上下文的切换：一次是在执行系统调用后，由用户态转向内核态时：另一次是在系统完成用户请求的服务后，由内核态返回用户态时。

在微内核OS中，客户和服务器、服务器和服务器之间的通信都须通过微内核，这使得同样的服务请求至少需要进行4次上下文切换。第1次发生在客户发送请求消息给微内核，以请求取得某服务器特定的服务时；第2次发生在由微内核把客户的请求消息发往服务器时；第3次发生在服务器完成客户的请求后，把响应消息发送到微内核时：第4次发生在微内核将响应消息发送给客户时。实际情况往往还会引起更多的上下文切换。例如，当某个服务器自身尚无能力完成客户请求而需要其他服务器帮助时，如图1-1所示，其中的文件服务器需要磁盘设备服务器的帮助，这时就需要进行8次上下文的切换。

![image-20220924094227115](https://pic.imgdb.cn/item/632e61ab16f2c2beb1783689.png)

为了改善运行效率，可以重新把OS的一些常用基本功能，由服务器移入微内核中。这样可使客户对OS常用基本功能的请求所引发的用户/内核模式和上下文的切换次数，由4次或8次降为2次。但这又会使微内核的容量明显增大，使其在小型接口定义和适应性方面的优势有所下降，同时会提高微内核的设计代价。

### 1.6.5 外核结构

在传统OS中，只有内核可以管理硬件资源，应用程序通过内核提供的抽象接口间接地与硬件进行交互。随着计算机逐步发展，应用程序的需求多样性开始增加，内核提供的接口固定而成为程序提升性能、增强灵活性和拓展功能的瓶颈。但是，应用程序的需求一直变化，为每个程序的每种需求都提供接口不现实。因此，传统OS难以适应程序的个性化需求。

外核(exokernel)或外内核OS的基本思想是：内核不提供传统OS中的进程、虚拟存储器等抽象事物，而是专注于物理资源的隔离（保护）与复用。具体来说，在基于外核结构的OS中，一个非常小的内核负责保护系统资源，而硬件资源的管理则交给应用程序。

这样，OS就可以做到在保证资源安全的前提下，减少对应用程序的限制，充分满足应用程序对硬件资源的不同需求。图为麻省理工学院的具有外核结构的Aegis系统，由一个轻量级内核和库OS组成。外核只提供比较低层的硬件操作，在外核接口上层工作的库OS则提供更高级别的映射。这里的库OS的实现思想是：基于应用程序的需求来定制OS内核，将原本属于OS内核的功能以库的形式提供给用户。

![image-20220924094327662](https://pic.imgdb.cn/item/632e619e16f2c2beb1782837.png)

## 1.7 系统调用

程序接口是OS专门为用户程序而设置的，提供给程序员编程时使用，也是用户程序取得OS服务的唯一途径。程序接口由一组系统调用(system call)组成，因此，系统调用提供了用户程序和OS内核之间的接口。系统调用不仅可供所有的应用程序使用，还可供OS自身使用。在每个系统中，通常有几十条甚至上百条系统调用，可根据功能将它们划分成若干类，每一个系统调用都是一个能完成特定功能的子程序。

### 1.7.1 系统调用的概念

在OS中提供系统调用的目的是，使应用程序可以通过系统调用来间接调用OS中的相关过程，进而取得相应的服务。系统调用在本质上是应用程序请求OS内核完成某功能时的一种过程调用，但它是一种特殊的过程调用，它与一般的过程调用在下述几方面有着显著差别。

- 运行在不同的系统状态。一般的过程调用，其调用程序和被调用程序运行在相同的状态一内核态或用户态；而系统调用与一般的过程调用的最大区别就在于，系统调用的调用程序运行在用户态，而被调用程序运行在内核态。
- 状态的转换。由于一般的过程调用并不涉及系统状态的转换，因此可直接由调用过程转向被调用过程。但在运行系统调用时，由于调用过程和被调用过程工作处于不同的系统状态，因而不允许由调用过程直接转向被调用过程，需要通过软中断机制先由用户态转换为内核态，经内核分析后才能转向相应的系统调用处理子程序。
- 返回问题。在采用了抢占式（剥夺）调度方式的系统中，在被调用过程执行完成后，要对系统中所有要求运行的进程做优先级分析。当调用进程仍具有最高优先级时，才返回到调用进程继续执行；否则，将重新调度，以便让优先级最高的进程优先执行。此时，将把调用进程放入就绪队列。
- 嵌套调用。像一般的过程调用一样，系统调用也可以嵌套进行，即在一个被调用过程执行期间，还可以利用系统调用命令去调用另一个系统调用。当然，每个系统调用对嵌套调用的深度都有一定的限制，如最大深度为6。但一般的过程调用对嵌套调用的深度则没有限制。图1-13所示为无嵌套调用与有嵌套调用这两种情况下的系统调用。

![image-20220924084733371](https://pic.imgdb.cn/item/632e540316f2c2beb16a3e76.png)

要写一个程序，从一个文件中读出数据，再将该数据复制到另一文件中。首先须输人该程序的输入文件名和输出文件名。文件名由程序来询问这两个文件名。在交互式系统中，该方式要使用一系列的系统调用，先在屏幕上打印出一系列的提示信息，再从键盘终端读人定义这两个文件名的字符串。在获得两个文件名后，程序又必须利用系统调用open去打开输人文件，并用系统调用creat去创建指定的输出文件；在执行系统调用open时，又可能发生错误。

例如，程序试图去打开一个不存在的文件，或者该文件虽然存在，但并不允许被访问等。此时，程序又须利用多条系统调用去显示出错信息，继而利用一个系统调用去实现程序的异常终止。类似地，在执行系统调用creat时，同样可能出现错误。例如，系统中早已有了与输出文件同名的另一文件，这时又须利用一个系统调用来结束程序，或者利用一个系统调用来删除已存在的那个同名文件，此后再利用系统调用creat来创建输出文件。

在打开输入文件和创建输出文件都获得成功后，还须通过用于申请内存的系统调用alloc来根据文件的大小申请一个缓冲区。申请成功后，再利用系统调用read从输入文件中把数据读到缓冲区内。读完后，又用系统调用close去关闭输人文件。然后，利用系统调用write把缓冲区内的数据写到输出文件中。在读过程或写过程中，都有可能需要回送各种出错信息。例如，在写过程中，可能发现已到达文件末尾指定的字符数尚未读够，或者遇见各种与输出设备类型有关的错误（如已无磁盘空间、打印机缺纸等）：在读过程中，可能发现硬件故障，如奇偶校验错误等。在将整个文件复制完后，程序又须利用系统调用close去关闭输出文件，并向控制台发出一消息，以指示复制完毕。最后，再利用系统调用exit使程序正常结束。综上所述可知，一个用户程序需要频繁地利用各种系统调用来取得OS所提供的多种服务。

系统调用是通过中断机制实现的，并且一个OS的所有系统调用都通过同一个中断入口来实现。例如，MS-DOS系统提供了INT21H这一中断，应用程序通过该中断获取OS的服务。对于拥有保护机制的OS来说，中断机制本身也是受保护的。在IBM公司所生产的个人计算机上，1ntel提供了多达255个中断号，但只有授权给应用程序保护等级的中断号，才可以被应用程序调用的。对于未被授权的中断号，如果应用程序对其进行调用，则会引发保护异常，进而导致自己被OS停止。例如，Linux系统仅给应用程序授权了4个中断号，即3H、4H、5H、80H，前3个中断号是提供给应用程序进行调试所使用的，而80H则是用于系统调用的中断号。

### 1.7.2 系统调用的类型

**1、进程控制类系统调用**

- 创建和终止进程的系统调用。利用创建进程的系调用为想要参加并发执行的程序创建一个进程，当进程执行结束后，再利用终止进程的系统。用来终止该进程。
- 获得和设置进程属性的系统调用。进程的属性包括进程标识符、进程代先级、最大允许执行时间等。利用获得进程属性的系统调用可了解某进程的属性，利用设置透属性的系统调用可确定和重新设置进程的属性。
- 等待某事件出现的系统调用。进程在执行过程中，假设需要等待某事件（条件）出现后方可继续执行。此时，进程可利用等待某事件出的系统调用来使自己处于等待状态，一旦等待的事件出现，便可将自己唤醒。

**2、文件操纵类系统调用**

- 创建和删除文件的系统调用。利用创建文件的系统调用，请求系统创建一个新文件；利用删除文件的系统调用，将指定文件删除。
- 打开和关闭文件的系统调用。用户在第一次访问某个文件之前，应先利用打开文件的系统调用将指定文件打开；在访问结束后，应利用关闭文件的系统调用将指定文件关闭。
- 读和写文件的系统调用。用户可利用读文件的系统调用，从已打开的文件中读出给定数目的字符，并将它们送至指定的缓冲区中；也可利用写文件的系统调用，从指定的缓冲区中将给定数目的字符写入文件中。读和写文件的系统调用是文件操纵类中使用最频繁的系统调用。

**3、进程通信类系统调用**

- 当采用信息传递方式时，在通信前须先打开一个连接。为此，应由源进程发出一条打开连接的系统调用，而目标进程则应利用接受连接的系统调用表示同意进行通信：然后，在源进程和目标进程之间便可开始通信。可以利用发送信息的系统调用和接收信息的系统调用来交换信息。通信结束后，还须利用关闭连接的系统调用来结束通信。
- 当采用共享存储区方式时，在通信前须先利用建立共享存储区的系统调用来建立一个共享存储区，再利用建立连接的系统调用将该共享存储区连接到进程自身的虚地址空间上，然后便可利用读和写共享存储区的系统调用来实现相互通信。除了上述的3大类系统调用外，常用的系统调用还包括设备管理类系统调用和信息维护类系统调用，前者主要用于实现申请设备、释放设备、设备I/O重定向、获得和设置设备属性等功能，后者主要用于获得包括有关系统和文件的时间信息、OS版本、当前用户以及有关空闲内存和磁盘空间大小等多方面的信息。

## 1.8 小结

一个完整的计算机系统由硬件和软件组成。硬件是软件得以建立和开展活动的基础，而软件则是对硬件功能的扩充。OS是裸机之上的第一层系统软件，它向下管理系统中各类资源，向上为用户和程序提供服务。本章主要介绍了OS的目标、作用、发展过程、基本特征、运行环境、主要功能、结构以及系统调用等内容。

OS的发展过程很长，从OS开始替代操作人员到发展出现代多道程序系统，这一过程中依次发展出了多种类型的OS，具体而言，有早期的批处理系统、分时系统、实时系统，还有现代的微机OS、嵌人式OS、网络OS和分布式OS等。

OS具有并发、共享、虚拟和异步等特征，其运行需要硬件支持。为了保护系统不被破坏，处理机的运行模式可分为两种，即用户态和内核态，可能引起系统危险的特权指令只能运行在内核态中。OS是中断驱动的，因此中断和异常是计算机系统中的一个重要机制，它保证了OS的正常运行。

传统OS具备的功能包括：进程管理、内存管理、设备管理、文件管理和接口管理。现代OS除了具备传统OS所具备的功能外，还具备保障系统安全、支持用户通过联网获取服务、可处理多媒体信息等功能OS是一个大型的系统软件，采用结构化的设计很重要。早期的OS基本无结构，现代流行的OS则多采用模块化结构、分层式结构、微内核结构等设计而成，最新的OS有的还是采用外核结构设计而成的。系统调用是OS内核与用户程序之间的接口，每个OS都提供了大量的系统调用给程序员使用。



