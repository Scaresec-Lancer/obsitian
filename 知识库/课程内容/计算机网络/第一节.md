# 9.5

考试课（54学时理论 + 36学时实验 ）60%卷面 + 20%实验 + 20%平时![](https://pic.imgdb.cn/item/63153b0416f2c2beb1eaf6ae.png)

## 1.1 计算机网络在信息时代中的作用
21世纪重要特征：数字化、网格化、信息化，是一个以网络为核心的信息时代。

三大网络：电信网络、有线电视网络、计算机网络。

互联网两个重要基本特点：连通性和共享，资源共享包括**信息共享、软件共享、硬件共享**

对于仅在局部范围互联起来的计算机网络，只能称之为互连网

## 1.2 互联网概述

计算机网络由若干节点（node）和连接这些节点的链路（link）组成，多个网络通过一些路由器相互连接起来，构成一个覆盖范围更大的计算机网络，称为互连网。

网络把许多计算机连接在一起，互连网把许多网络通过一些路由器连接在一起，与网络相连的计算机常称为主机。

互联网服务提供者ISP，比如移动、电信、联通；为了更快的转发分组，互联网交换点IXP应运而生。



互联网基础结构发展的三个阶段：

- 从单个网络ARPANET向互连网发展的过程
- 建成了三级结构的互联网：主干网、地区网、校园网（或企业网）
- 形成全球范围的多层次ISP结构的互联网



互联网机构：

- 互联网协会ISOC
- 互联网体系结构委员会IAB
- 互联网工程部IRTF
- 互联网研究部IRTF



制订互联网的正式标准需要三个阶段：

- 互联网草案，有效期6个月
- 建议标准，开始成为RFC文档
- 互联网标准，一个标准可以和多个RFC文档关联

## 1.3 互联网的组成
从工作方式上看，划分为两大块：
 - 边缘部分 由所有连接在互联网上的主机组成，这部分用户直接使用，用来进行通信（传送数据、音频或视频）和资源共享
 - 核心部分 由大量网络和连接这些网络的路由器组成，为边缘部分提供服务（提供连通性和交换）

**分享：什么软件用了P2P，工作原理**

- https://www.sohu.com/a/389909459_117107

**互联网的边缘部分**

处在互联网边缘的部分就是连接在互联网上所有的主机，又称为端系统，小的端系统可能是笔记本电脑和智能手机，大的可以是服务器。

主机A和主机B进行通信是指，主机A的某个进程和主机B上的另一个进程进行通信，在网络边缘的端系统之间的通信分为两大类：客户-服务器方式（C/S）和对等方式（P2P）

C/S方式中，客户client和服务器server都是通信中设计的两个应用进程，客户是服务请求方，服务器是服务提供方

P2P方式中，两台主机在通信中并不区分哪一个是服务请求方和服务提供方，二者只要都运行了对等连接软件，就可以平等的对等连接通信

**互联网的核心部分**

在网络核心部分起特殊作用的是路由器，一种专用计算机（但不叫做主机），实现分组交换的关键构件



电路交换的主要特点：

从通信资源的分配角度看，交换就是动态分配传输线路的资源。拨打电话时，从主叫端到被叫端建立了一条专用的物理通路，经历了建立连接（占用通信资源）、通话（一直占用通信资源）、释放连接（归还通信资源）这三个步骤的交换方式称为电路交换。电路交换的一个重要特点：在通话的全部时间里，通信的两个用户始终占用端到端的通信资源。

用电路交换来传送计算机数据时，线路传输效率往往很低，因为计算机数据是突发式地出现在传输线路上的



分组交换的主要特点：

分组交换使用存储转发技术，通常把要发送的整块数据称为一个报文，发送前将报文划分为一个个等长数据段，在每个数据段前面加上一些必要的控制信息组成的首部（header），构成一个分组（packet），又称为包，分组的首部也成为包头

在互联网核心部分的路由器之间一般使用高速链路相连，而在网络边缘部分的主机介入到核心部分则通常以相对较低速率的链路

位于边缘的主机和位于核心的路由器都是计算机，但主机为用户进行信息处理，而路由器用来转发分组：路由器找到一个分组，先暂时存储一下，检查其首部，查找转发表，按照首部中的目的地址找到合适的接口转发出去，把分组交给下一个路由器，这样一步一步的以存储转发的方式，把分组交付最终的目的主机

各路由器之间必须经常交换彼此掌握的路由信息，以便创建和动态维护路由器中的转发表

分组交换的优点：

| 优点 | 所采用的手段                                                 |
| ---- | ------------------------------------------------------------ |
| 高效 | 在分组传输的过程中动态分配传输带宽，对通信链路逐段占用       |
| 灵活 | 为每一个分组独立的选择最合适的转发路由                       |
| 迅速 | 以分组为传送单位，不先建立连接就能向其他主机发送分组         |
| 可靠 | 保证可靠性的网络协议；分布式多路由的分组交换网，使网络有很好的生存性 |



分组交换也有问题，比如分组在各路由器存储转发时要排队，造成一定的时延，各分组必须携带的控制信息也造成了一定的开销，整个分组交换网还需要专门的管理和控制机制



三种交换方式在数据传送阶段的主要特点：

- 电路交换——整个报文的比特流连续的从源头直达终点
- 报文交换——整个报文先传送到相邻节点，全部存储下来后转发到下一个节点
- 分组交换——单个分组（报文的一部分）传送到相邻节点，存储后转发到下一个节点

![image-20220906000707563](https://pic.imgdb.cn/item/63161eeb16f2c2beb1e1f90c.png)

若需要连续传送大量数据，且传送时间远大于连接建立时间，则电路交换的传输速率快。报文交换和分组交换不需要预先分配传输带宽，在传送突发数据时可提高整个网络的信道利用率。由于一个分组的长度远小于整个报文的长度，所以分组交换时延小，灵活性好。

从第四代蜂窝移动网络开始，无论是语音通话还是数据通信，都要采用分组交换

## 1.4 计算机网络在我国的发展

## 1.5 计算机网络的类别

### 1.5.2 不同的计算机网络

**按网络的作用范围进行分类**

- 广域网WAN：作用范围几十到几千公里，是互联网的核心部分，连接广域网各节点交换机一般为高速链路
- 城域网MAN：范围是一个城市，可跨越几个街区甚至整个城市，可以为一个或几个单位所拥有，也可以是公用设施，用来将多个局域网进行互连，目前很多城域网采用的是以太技术。
- 局域网LAN：一般用微型计算机或工作站通过高速通信线路相连，学校和企业大都拥有多个互连的局域网（称为校园网或企业网）
- 个人局域网PAN：把属于个人的电子设备用无线技术连接起来的技术，范围约10m左右



**按网络的使用者进行分类**

- 公用网：指电信公司出资建造的大型网络
- 专用网：某个部门为满足本单位的特殊业务工作的需要而建造的网络，例如军队、铁路、银行、电力等系统均有专用网



**用来把用户接入到互联网的网络**

接入网AN，又称本地接入网或居民接入网

## 1.6 计算机网络的性能

![无标题画板](https://pic.imgdb.cn/item/632c1f9c16f2c2beb135a1a3.png)

### 1.6.1 计算机网络的性能指标

**1、速率**

网络技术中的速率指数据的传送速率，也成为数据率或比特率，单位是bit/s。当提到网络的速率时，往往指额定速率或标称速率，而并非实际运行速率。

**2、带宽**

带宽有以下两种不同的含义：

- 指某个信号具有的频带宽度。信号的带宽指该信号包含各种不同频率成分所占据的频率范围，单位为赫
- 指计算机网络中，表示某通道传送数据的能力，单位时间内网络中某信道所能通过的最高数据率，单位为bit/s

> 计算机领域，数的计算使用二进制，K=2^10，M=2^20，G=2^30；但在通信领域，K=10^3，M=10^6，G=10^9

在带宽的上述两种表述中，前者为频域称谓，后者为时域称谓，其本质是相同的，也就是说，一条通信链路的带宽越宽，所能传输的最高数据率也越高。

**3、吞吐量**

指单位时间内通过某个网络（或信道、接口）的实际数据量

**4、时延**

指数据（一个报文或分组，甚至比特）从网络一段传送到另一端所需的时间，也称延迟或迟延。时延由以下几部分组成：

- 发送时延：主机或路由器发送数据帧所需的时间，`发送时延=数据帧长度/发送速率`，由此可见对一定的网络，发送时延并非固定不变，而是与发送的帧长成正比，与发送速率成反比
- 传播时延：指电磁波在信道中传播一定距离花费的时间，`传播时延=信道长度/电磁波在信道上的传播速率`。电磁波在自由空间的传播速率是光速，即3.0×10^5 km/s , 在铜线电缆中约为2.3×103km/s，在光纤中约为2.0×10km/s。

> 以上两种时延有本质上的不同：发送时延在机器内部的发送器中，与传输信道的距离没有任何关系；传播时延则发生在机器外部的传输信道媒体上，而与信号的发送速率无关，距离越远，传播时延就越大。

- 处理时延：主机或路由器在收到分组时要花费一定的时间进行处理，例如分析分组的首部、从分组中提取数据部分、进行差错检验或查找转发表等

- 排队时延：分组在进入路由器后，要先在输入队列中排队等待处理。在路由器确定了转发接口后，还要在输出队列中排队等待转发。排队时延的长短往往取决于网络当时的通信量，当网络的通信量很大时会发生队列溢出，使分组丢失，这相当于排队时延为无穷大。

数据在网络中经历的总时延就是以上四种时延之和：`总时延=发送时延+传播时延+处理时延+排队时延`
![image-20220922154830185](https://pic.imgdb.cn/item/632c13ab16f2c2beb126a897.png)

对于高速网络链路，我们提高的是数据的发送速率。电磁波在通信线路上的传播速率取决于通信线路的介质材料，而与数据的发送速率并无关系。提高数据的发送速率只是减小了数据的发送时延。

还有一点，数据的发送速率的单位是每秒多少个比特，是指在某个点或某个接口上的发送速率。而传播速率的单位是每秒多少公里，是指在某一段传输线路上比特的传播速率。因此，通常所说的“光纤信道的传输速率高”是指可以用很高的速率向光纤信道发送数据，而光纤信道的传播速率实际上还要比铜线的传播速率略低一点。

**5、时延带宽积**

![image-20220922155432149](https://pic.imgdb.cn/item/632c150b16f2c2beb1280257.png)

`时延带宽积=传播时延*带宽`

这是一个代表链路的圆柱形管道，管道的长度是链路的传播时延（请注意，现在以时间作为单位来表示链路长度），而管道的截面积是链路的带宽。

时延带宽积就表示这个管道的体积，表示这样的链路可容纳多少个比特。例如，设某段链路的传播时延为20ms,带宽为10Mbit/s,算出时延带宽积=20×103×10×10=2×105bit这就表明，若发送端连续发送数据，则在发送的第一个比特即将到达终点时，发送端就已经发送了20万个比特，而这20万个比特都正在链路上向前移动。因此，链路的时延带宽积又称为以比特为单位的链路长度。

不难看出，管道中的比特数表示从发送端发出但尚未到达接收端的比特数。对于一条正在传送数据的链路，只有在代表链路的管道都充满比特时，链路才得到最充分的利用。

**6、往返时间RTT**

我们有时需要知道双向交互一次所需的时间。例如，A向B发送数据。如果数据长度是100MB,发送速率是100Mbit/s,那么 `发送时间=数据长度/发送速率=8.39s`

假定B收完数据后立即向A发送确认。再假定A只有在收到B的确认信息后，才能继续向B发送数据。显然，这就要等待一个往返时间RTT(这里假定确认信息很短，可忽略B发送确认的发送时延)。如果RTT=2s,那么可以算出A向B发送数据的有效数据率。`有效数据率=数据长度/(发送时间+RTT)=80.7Mbit/s`，比原来的100Mbit/s小不少。

在互联网中，RTT还包括各中间节点的处理时延、排队时延以及转发数据时的发送时延。当使用卫星通信时，往返时间RTT相对较长。

**7、利用率**

利用率有信道利用率和网络利用率两种。

信道利用率指出某信道有百分之几的时间是被利用的（有数据通过）。完全空闲的信道的利用率是零。网络利用率则是全网络的信道利用率的加权平均值。

信道利用率并非越高越好，根据排队论的理论，当某信道的利用率增大时，该信道引起的时延也就迅速增加。当网络的通信量很少时，网络产生的时延并不大。但在网络通信量不断增大的情况下，由于分组在网络节点（路由器或节点交换机）进行处理时需要排队等候，因此网络引起的时延就会增大。

如果令D0表示网络空闲时的时延，D表示网络当前的时延(设现在的网络利用率为U),那么在适当的假定条件下，可以用下面的公式来表示D与D0以及利用率U之间的关系：`D=D0/(1-U)`

这里U是网络利用率，数值在0到1之间。当网络利用率达到其容量的1/2时，时延就要加倍。特别值得注意的就是：当网络利用率接近最大值1时，网络产生的时延就趋于无穷大。因此我们必须有这样的概念：信道利用率或网络利用率过高就会产生非常大的时延。因此，一些拥有较大主干网的ISP通常控制信道利用率不超过50%。如果超过了就要准备扩容，增大线路的带宽。

![image-20220922162204101](https://pic.imgdb.cn/item/632c1b8616f2c2beb130c24e.png)

### 1.6.2 计算机网络的非性能特征

**1、费用**

网络的价格（包括设计和实现的费用）总是必须考虑的，因为网络的性能与其价格密切相关。一般说来，网络的速率越高，其价格也越高。

**2、质量**

网络的质量取决于网络中所有构件的质量，以及这些构件是怎样组成网络的。网络的质量影响到很多方面，如网络的可靠性、网络管理的简易性，以及网络的一些性能。但网络的性能与网络的质量并不是一回事。例如，有些性能一般的网络，运行一段时间后就出现了故障，变得无法再继续工作，说明其质量不好。高质量的网络往往价格也较高。

**3、标准化**

网络的硬件和软件的设计既可以按照通用的国际标准，也可以遵循特定的专用网络标准。最好采用国际标准的设计，这样可以得到更好的互操作性，更易于升级换代和维修，也更容易得到技术上的支持。

**4、可靠性**

可靠性与网络的质量和性能都有密切关系。高速网络的可靠性不一定很差。但高速网络要可靠地运行，则往往更加困难，同时所需的费用也会较高。

**5、可扩充性和可升级性**

在构造网络时就应当考虑到今后可能会需要扩展（即规模扩大）和升级（即性能和版本的提高)。网络的性能越好，其扩展费用往往也越高，难度也会相应增加。

**6、易于管理和维护**

网络如果没有良好的管理和维护，就很难达到和保持所设计的性能

## 1.7 计算机网络体系结构

![临时](https://pic.imgdb.cn/item/632c499716f2c2beb163c0a7.png)

### 1.7.1 计算机网络体系结构的形成

计算机网络是个非常复杂的系统。为了说明这一点，可以设想一种最简单的情况：连接在网络上的两台计算机要互相传送文件。显然，在这两台计算机之间必须有一条传送数据的通路。但这还远远不够。至少还有以下几项工作需要去完成：

- 发起通信的计算机必须将数据通信的通路**激活**。所谓“激活”就是要发出一些信令，保证要传送的计算机数据能在这条通路上正确发送和接收。
- 告诉网络如何识别接收数据的计算机。
- 发起通信的计算机必须查明对方计算机是否已开机，并且与网络连接正常。
- 发起通信的计算机中的应用程序必须弄清楚，在对方计算机中的文件管理程序是否己做好接收文件和存储文件的准备工作。
- 若计算机的文件格式不兼容，则至少其中一台计算机应完成格式转换功能。
- 对出现的各种差错和意外事故，如数据传送错误、重复或丢失，网络中某个节点交换机出现故障等，应当有可靠的措施保证对方计算机最终能够收到正确的文件。

由此可见，相互通信的两个计算机系统必须高度协调工作才行，而这种“协调”是相当复杂的。为了设计这样复杂的计算机网络，早在最初的ARPANET设计时即提出了分层的方法。“**分层**”可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于研究和处理。

I974年，IBM公司宣布了系统网络体系结构SNA.这个著名的网络标准就是按照分层的方法制定的。

为了使不同体系结构的计算机网络都能互连，国际标准化组织ISO于1977年提出了著名的**开放系统互连基本参考模型OSI/RM**，简称为OSI。“开放”是指非独家垄断的。因此只要遵循OSI标准，一个系统就可以和位于世界上任何地方的、也遵循这同一标准的其他任何系统进行通信。“系统”是指在现实的系统中与互连有关的各部分,OSI/RM是个抽象的概念。在1983年形成了OSI的正式文件，即著名的ISO 7498国际标准，也就是所谓的七层协议的体系结构。

20世纪90年代，基于TCP/IP的互联网已抢先成功地运行了，却几乎找不到符合OSI标准的商用产品。OSI失败的原因可归纳为：

- OSI的专家们缺乏实际经验，他们在完成OSI标准时缺乏商业驱动力：
- OSI的协议实现起来过分复杂，而且运行效率很低：
- OSI标准的制定周期太长，因而使得按OSI标准生产的设备无法及时进入市场：
- OSI的层次划分不太合理，有些功能在多个层次中重复出现。

按照一般的概念，网络技术和设备只有符合有关的国际标准才能大范围地获得工程上的应用。但现在情况却反过来了。得到最广泛应用的不是法律上的**国际标准OSI**,而是**非国际标准TCP/IP**。这样，TCP/IP就常被称为是事实上的国际标准。

### 1.7.2 协议与划分层次

在计算机网络中要做到有条不紊地交换数据，就必须遵守一些事先约定好的规则。这些规则明确规定了所交换的数据的格式以及有关的同步问题。这些为进行网络中的数据交换而建立的规则、标准或约定称为网络协议，主要由以下三个要素组成：

- 语法，即数据与控制信息的结构或格式：
- 语义，即需要发出何种控制信息，完成何种动作以及做出何种响应：
- 同步，即事件实现顺序的详细说明。

ARPANET的研制经验表明，对于非常复杂的计算机网络协议，其结构应该是层次式的。

![image-20220922170555789](https://pic.imgdb.cn/item/632c25c716f2c2beb13d79a0.png)

但是，我们并不想让文件传送模块完成全部工作的细节，这样会使文件传送模块过于复杂。可以再设立一个通信服务模块，用来保证文件和文件传送命令可靠地在两个系统之间交换。这就是我们要做的第二类工作。也就是说，让位于上面的文件传送模块利用下面的通信服务模块所提供的服务。我们还可以看出，如果将位于上面的文件传送模块换成电子邮件模块，那么电子邮件模块同样可以利用在它下面的通信服务模块所提供的可靠通信的服务。我们要做的第三类工作可以是再构造一个网络接入模块，让这个模块负责做与网络接口细节有关的工作，并向上层提供服务，使上面的通信服务模块能够完成可靠通信的任务。从上述的简单例子可以更好地理解分层能带来很多好处，如：

- 各层之间是独立的。某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道该层通过层间的接口（即界面）所提供的服务。

- 灵活性好。当任何一层发生变化时（例如由于技术的变化），只要层间接口关系保持不变，那么在这层以上或以下各层均不受影响。

- 结构上可分割开。各层都可以采用最合适的技术来实现。

- 易于实现和维护。这种结构使得实现和调试一个庞大而又复杂的系统变得更加容易，因为整个系统已被分解为若干个相对独立的子系统。

- 能促进标准化工作。分层时应注意使每一层的功能非常明确。若层数太少，就会使每一层的协议太复杂：但层数太多又会在描述和综合各层功能的系统工程任务时遇到较多的困难。通常各层所要完成的功能主要有以下一些（可以只包括一种，也可以包括多种）：

  - 差错控制  使相应层次对等方的通信更加可靠。

  - 流量控制  发送端的发送速率必须使接收端来得及接收，不要太快。

  - 分段和重装  发送端将要发送的数据块划分为更小的单位，在接收端将其还原。

  - 复用和分用  发送端几个高层会话复用一条低层的连接，在接收端再进行分用。

  - 连接建立和释放  交换数据前先建立一条逻辑连接，数据传送结束后释放连接。

**计算机网络的各层及其协议的集合就是网络的体系结构**。换种说法，**计算机网络的体系结构就是这个计算机网络及其构件所应完成的功能的精确定义**[GEE82]。需要强调的是：这些功能究竟是用何种硬件或软件完成的，则是一个遵循这种体系结构的实现的问题。体系结构的英文名词architecture的原意是建筑学或建筑的设计和风格。它和一个具体的建筑物的概念很不相同。**体系结构是抽象的，而实现则是具体的，是真正在运行的计算机硬件和软件**。

### 1.7.3 具有五层协议的体系结构

![image-20220922165517475](https://pic.imgdb.cn/item/632c234816f2c2beb139e317.png)

 OSI的七层协议体系结构的概念清楚，理论也较完整，但它既复杂又不实用。TCP/IP体系结构则不同，它现在得到了非常广泛的应用。

**应用层**

应用层是体系结构中的最高层，任务是通过应用进程间的交互来完成特定网络应用。应用层协议定义的是应用进程间通信和交互的规则。这里的进程就是指主机中正在运行的程序，对于不同的网络应用需要有不同的应用层协议。

互联网中的应用层协议很多，如域名系统DNS、支持万维网应用的HTTP协议、支持电子邮件的SMTP协议，等等。我们把应用层交互的数据单元称为报文。

**运输层**

运输层的任务是负责向两台主机中进程之间的通信提供通用的数据传输服务。应用进程利用该服务传送应用层报文。通用是指并不针对某个特定网络应用，多种应用可以用同一个运输层服务。由于一台主机可同时运行多个进程，因此运输层有复用和分用的功能。复用就是多个应用层进程可同时使用下面运输层的服务，分用和复用相反，是运输层把收到的信息分别交付上面应用层中的相应进程。

运输层主要使用以下两种协议：

- 传输控制协议TCP——提供面向连接的、可靠的数据传输服务，其数据传输的单位是报文段。
- 用户数据报协议UDP——提供无连接的尽最大努力的数据传输服务（不保证数据传输的可靠性），其数据传输的单位是用户数据报。

**网络层**

网络层负责为分组交换网上的不同主机提供通信服务。发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组或包进行传送。在TCP/IP体系中，由于网络层使用IP协议，因此分组也叫作IP数据报，或简称为数据报。此外，无论在哪一层传送的数据单元，都可笼统地用“分组”来表示。

网络层的具体任务有两个。第一个任务是通过一定的算法，在互联网中的每一个路由器上生成一个用来转发分组的转发表。第二个任务较为简单，就是每一个路由器在接收到一个分组时，依据转发表中指明的路径把分组转发到下一个路由器。

互联网是由大量的异构网络通过路由器相互连接起来的。互联网使用的网络层协议是无连接的网际协议IP和许多种路由选择协议，因此互联网的网络层也叫作网际层或IP层。在本书中，网络层、网际层和IP层都是同义语。

**数据链路层**

两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要专门的链路层的协议。在两个相邻节点之间传送数据时，数据链路层将网络层交下来的IP数据报组装成帧，在两个相邻节点间的链路上传送帧。每一帧包括数据和必要的控制信息（如同步信息、地址信息、差错控制等）。在接收数据时，控制信息使接收端能够知道一个帧从哪个比特开始和到哪个比特结束。这样，数据链路层在收到一个帧后，就可从中提取出数据部分，上交给网络层。

控制信息还使接收端能够检测到所收到的帧中有无差错。如发现有差错，数据链路层就简单地丢弃这个出了差错的帧，以免继续在网络中传送下去白白浪费网络资源。如果需要改正数据在数据链路层传输时出现的差错（这就是说，数据链路层不仅要检错，而且要纠错)，那么就要采用可靠传输协议来纠正出现的差错。这种方法会使数据链路层的协议复杂些。

**物理层**

在物理层上所传数据的单位是比特。物理层要考虑用多大的电压代表“1”或“0”，以及接收方如何识别出发送方所发送的比特。物理层还要确定连接电缆的插头应当有多少根引脚以及各引脚应如何连接。传递信息所利用的一些物理传输媒体，如双绞线、同轴电缆、光缆、无线信道等，并不在物理层协议之内，而是在物理层协议的下面。因此也有人把物理层下面的物理传输媒体当作第0层。

在互联网所使用的各种协议中，最重要的和最著名的就是TCP和IP两个协议。现在人们经常提到的TCP/IP并不一定是单指TCP和IP这两个具体的协议，而往往是表示互联网所使用的整个TCP/IP协议族。下图说明的是应用进程的数据在各层之间的传递过程中所经历的变化。这里为简单起见，假定两台主机通过一台路由器连接起来。

![image-20220922185618088](https://pic.imgdb.cn/item/632c3fa516f2c2beb159baad.png)

假定主机1的应用进程AP1向主机2的应用进程AP2传送数据。AP1先将其数据交给本主机的第5层（应用层）。第5层加上必要的控制信息H5就变成了下一层的数据单元。第4层（运输层）收到这个数据单元后，加上本层的控制信息H4,再交给第3层（网络层），成为第3层的数据单元。依此类推。不过到了第2层（数据链路层）后，控制信息被分成两部分，分别加到本层数据单元的首部(H2)和尾部(T2):而第1层（物理层）由于是比特流的传送，所以不再加上控制信息。传送比特流时应从首部开始传送。

OSI参考模型把对等层次之间传送的数据单位称为该层的协议数据单元PDU，这个名词现已被许多非OSI标准采用。

当这一串的比特流离开主机1经网络的物理传输媒体传送到路由器时，就从路由器的第1层依次上升到第3层。每一层都根据控制信息进行必要的操作，然后将控制信息剥去，将该层剩下的数据单元上交给更高的一层。当分组上升到了第3层网络层时，就根据首部中的目的地址查找路由器中的转发表，找出转发分组的接口，然后往下传送到第2层，加上新的首部和尾部后，再到最下面的第1层，然后在物理传输媒体上把每一个比特发送出去。

当这一串的比特流离开路由器到达目的站主机2时，就从主机2的第1层按照上面讲过的方式，依次上升到第5层。最后，把应用进程AP1发送的数据交给目的站的应用进程AP2

虽然应用进程数据要经过如图所示的复杂过程才能送到终点的应用进程，但这些复杂过程对用户屏蔽掉了，以致应用进程AP1觉得好像是直接把数据交给了应用进程AP2。同理，任何两个同样的层次（例如在两个系统的第4层）之间，也好像如同图中的水平虚线所示的那样，把数据（即数据单元加上控制信息）通过水平虚线直接传递给对方。这就是所谓的“对等层”之间的通信。我们以前经常提到的各层协议，实际上就是在各个对等层之间传递数据时的各项规定。

在文献中也还可以见到术语“协议栈”，这是因为几个层次画在一起很像一个栈的结构。

### 1.7.4 实体、协议、服务和服务访问点

当研究开放系统中的信息交换时，往往使用实体这一较为抽象的名词表示**任何可发送或接收信息的硬件或软件进程**。在许多情况下，实体就是一个特定的软件模块。

**协议是控制两个对等实体（或多个实体）进行通信的规则的集合**。协议的语法方面的规则定义了所交换的信息的格式，而协议的语义方面的规则就定义了发送者或接收者所要完成的操作，例如，在何种条件下，数据必须重传或丢弃。在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务。要实现本层协议，还需要使用下面一层所提供的服务。

一定要弄清楚，协议和服务在概念上是很不一样的。首先，协议的实现保证了能够向上一层提供服务。**使用本层服务的实体只能看见服务而无法看见下面的协议**。也就是说，下面的协议对上面的实体是透明的。

其次，**协议是“水平的”**，即协议是控制对等实体之间通信的规则。但**服务是“垂直的”**，即服务是由下层向上层通过层间接口提供的。另外，并非在一个层内完成的全部功能都称为服务。只有那些能够被高一层实体“看得见”的功能才能称之为“服务”。上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令在OSI中称为服务原语。

在同一系统中相邻两层的实体进行交互（即交换信息）的地方，通常称为服务访问点SAP。服务访问点SAP是一个抽象的概念，它实际上就是一个逻辑接口，有点像邮政信箱（可以把邮件放入信箱和从信箱中取走邮件），但这种层间接口和两个设备之间的硬件接口（并行的或串行的）并不一样。OSI把层与层之间交换的数据的单位称为服务数据单元SDU,它可以与PDU不一样。例如，可以是多个SDU合成为一个PDU,也可以是一个SDU划分为几个PDU。

这样，在任何相邻两层之间的关系均可概括为图1-18所示的那样。这里要注意的是，第n层的两个“实体(n)”之间通过“协议(n)”进行通信，而第n+1层的两个“实体(n+1)”之间则通过另外的“协议(n+1)”进行通信（每一层都使用不同的协议）。第n层向上面的第n+1层所提供的服务实际上已包括了在它以下各层所提供的服务。第n层的实体对第n+1层的实体就相当于一个服务提供者。在服务提供者的上一层的实体又称为“服务用户”，因为它使用下层服务提供者所提供的服务。

![image-20220922191016495](https://pic.imgdb.cn/item/632c42ec16f2c2beb15d837a.png)

计算机网络的协议还有一个很重要的特点，就是协议必须把所有不利的条件事先都估计到。例如，两个朋友约好下午3时在公园碰头，并且约定“不见不散”。这就是一个很不科学的协议，任何一方临时有急事来不了又无法通知对方时（如对方的电话或手机都无法接通），则另一方按照协议就必须永远等待下去。

> 【例题1】：占据东、西两个山顶的蓝军1和蓝军2与驻扎在山谷的白军作战。其力量对比是：单独的蓝军1或蓝军2打不过白军，但蓝军1和蓝军2协同作战则可战胜白军。现蓝军1拟于次日正午向白军发起攻击。于是用计算机发送电文给蓝军2。但通信线路很不好，电文出错或丢失的可能性较大（没有电话可使用）。因此要求收到电文的友军必须送回一个确认电文。但此确认电文也可能出错或丢失。试问能否设计出一种协议使得蓝军1和蓝军2能够实现协同作战因而一定（即100%而不是99.999%）取得胜利？
>
> ![image-20220922191747517](https://pic.imgdb.cn/item/632c44ae16f2c2beb15f2fc1.png)
>
> 【解】：蓝军1先发送：“拟于明日正午向白军发起攻击。请协同作战和确认。”假定蓝军2收到电文后发回了确认。然而现在蓝军1和蓝军2都不敢下决心进攻。因为，蓝军2不知道此确认电文对方是否正确地收到了。如未正确收到，则蓝军1必定不敢贸然进攻。在此情况下，自己单方面发起进攻就肯定要失败。因此，必须等待蓝军1发送“对确认的确认”。假定蓝军2收到了蓝军1发来的确认。但蓝军1同样关心自己发出的确认是否已被对方正确地收到。因此还要等待蓝军2的“对确认的确认的确认”。这样无限循环下去，蓝军1和蓝军2都始终无法确定自己最后发出的电文对方是否已经收到。
>
> 因此，在本例题给出的条件下，没有一种协议可以使蓝军1和蓝军2能够100%地确保胜利。
>
> 



### 1.7.5 TCP/IP的体系结构

TCP/IP体系结构简单，只有4层：

![image-20220922191951062](https://pic.imgdb.cn/item/632c452a16f2c2beb15fb776.png)

互联网使用的TCP/IP体系结构已经演变成为图所示的，某些程序可以直接使用IP层，或直接使用最下面的链路层[PETE12]。虽然TCP/IP协议族得到了非常广泛的应用，但对TCP/IP体系结构的批评意见也有不少。例如，这个体系结构没有清晰地阐明区分开服务、接口和协议之间的关系，而链路层并非真正的一个层次，而仅仅是强调了IP层需要这样一个与网络的接口。这个体系结构没有把重要的物理层和链路层的内容包含进来。

![image-20220922192205327](https://pic.imgdb.cn/item/632c45b016f2c2beb1603230.png)

还有另一种方法用来表示TCP/IP协议族，它的特点是上下两头大而中间小：应用层和网络接口层都有多种协议，而中间的IP层很小，上层的各种协议都向下汇聚到一个IP协议中。这种很像沙漏计时器形状的TCP/IP协议族表明：IP层可以支持多种运输层协议（虽然这里只画出了最主要的两种），而不同的运输层协议上面又可以有多种应用层协议（所谓的everything over IP),同时IP协议也可以在多种类型的网络上运行（所谓的IP over everything)。正因为如此，互联网才会发展到今天的这种全球规模。从图不难看出IP协议在互联网中的核心作用。

![image-20220922192425882](https://pic.imgdb.cn/item/632c463d16f2c2beb160ad30.png)

> 【例1-2】利用协议栈的概念，说明在互联网中常用的客户服务器工作方式。
>
> ![image-20220922192957247](https://pic.imgdb.cn/item/632c478816f2c2beb161d643.png)
>
> 【解】图中的主机A和主机B都各有自己的协议栈。主机A中的应用进程（即客户进程)的位置在最高的应用层。这个客户进程向主机B应用层的服务器进程发出请求，请求建立连接（图中的1）。然后，主机B中的服务器进程接受A的客户进程发来的请求(图中的2)。所有这些通信，实际上都需要使用下面各层所提供的服务。但若仅仅考虑客户进程和服务器进程的交互，则可把它们之间的交互看成是图1-23中的水平虚线所示的那样。
>
> 图画出了三台主机的协议栈。主机C的应用层中同时有两个服务器进程在通信。服务器1在和主机A中的客户1通信，而服务器2在和主机B中的客户2通信。有的服务器进程可以同时向几百个或更多的客户进程提供服务。
>
> ![image-20220922193110550](https://pic.imgdb.cn/item/632c47d216f2c2beb1621596.png)

## 2.1 物理层的基本概念

